name: åˆå¹¶å¹¿å‘Šè§„åˆ™åˆ—è¡¨

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  merge-rules:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: ä¸‹è½½å¹¶åˆå¹¶è§„åˆ™
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p temp_rules
          
          # è§„åˆ™åˆ—è¡¨ï¼ˆä½ æä¾›çš„7ä¸ªï¼‰
          RULES=(
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_21.txt"
            "https://raw.githubusercontent.com/xinggsf/Adblock-Plus-Rule/master/rule.txt"
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt"
            "https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/AWAvenue-Ads-Rule.txt"
            "https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Replenish.txt"
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_53.txt"
            "https://adguardteam.github.io/HostlistsRegistry/assets/filter_29.txt"
          )
          
          # ä¸‹è½½æ‰€æœ‰è§„åˆ™æ–‡ä»¶
          for i in "${!RULES[@]}"; do
            echo "ä¸‹è½½è§„åˆ™ $((i+1)): ${RULES[$i]}"
            curl -L -f -o "temp_rules/rule_$i.txt" "${RULES[$i]}" || echo "âš ï¸ è­¦å‘Š: ä¸‹è½½å¤±è´¥ ${RULES[$i]}"
          done
          
          # åˆ›å»ºåˆå¹¶æ–‡ä»¶
          > merged_rules.txt
          
          # æŠŠæ‰€æœ‰æ–‡ä»¶çš„å†…å®¹ç›´æ¥åˆå¹¶ï¼ˆä¸æå–ã€ä¸è¿‡æ»¤ï¼‰
          for file in temp_rules/*.txt; do
            if [ -f "$file" ]; then
              echo "åˆå¹¶æ–‡ä»¶: $file"
              cat "$file" >> merged_rules.txt
              echo "" >> merged_rules.txt  # åŠ ä¸ªæ¢è¡Œé˜²æ­¢ç²˜è¿
            fi
          done
          
          # å»é™¤é‡å¤è¡Œï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªå‡ºç°çš„ï¼‰
          awk '!seen[$0]++' merged_rules.txt > merged_rules_deduped.txt
          
          # ç»Ÿè®¡è¡Œæ•°
          ORIGINAL_COUNT=$(wc -l < merged_rules.txt)
          DEDUPED_COUNT=$(wc -l < merged_rules_deduped.txt)
          echo "ğŸ“Š åŸå§‹æ€»è¡Œæ•°: $ORIGINAL_COUNT"
          echo "ğŸ“Š å»é‡åè¡Œæ•°: $DEDUPED_COUNT"
          echo "ğŸ“Š å»é‡æ•°é‡: $((ORIGINAL_COUNT - DEDUPED_COUNT))"
          
          # æ›¿æ¢åŸæ–‡ä»¶
          mv merged_rules_deduped.txt merged_rules.txt

      - name: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        id: check_changes
        run: |
          if [ -f merged_rules.txt ] && [ -f adblock_rules.txt ]; then
            if diff -q merged_rules.txt adblock_rules.txt >/dev/null; then
              echo "âœ… è§„åˆ™æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
              echo "changed=false" >> $GITHUB_OUTPUT
              rm -f merged_rules.txt
            else
              echo "ğŸ”„ è§„åˆ™æœ‰å˜åŒ–ï¼Œå‡†å¤‡æ›´æ–°"
              echo "changed=true" >> $GITHUB_OUTPUT
              mv merged_rules.txt adblock_rules.txt
            fi
          else
            echo "ğŸ”„ é¦–æ¬¡è¿è¡Œï¼Œåˆ›å»ºè§„åˆ™æ–‡ä»¶"
            echo "changed=true" >> $GITHUB_OUTPUT
            mv merged_rules.txt adblock_rules.txt
          fi

      - name: æäº¤æ›´æ–°æ–‡ä»¶
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add adblock_rules.txt
          git commit -m "ğŸ“¦ è‡ªåŠ¨åˆå¹¶å¹¿å‘Šè§„åˆ™ - $(date +'%Y-%m-%d') (å…± $(wc -l < adblock_rules.txt) æ¡)"
          git push

      - name: ç”Ÿæˆè§„åˆ™ç»Ÿè®¡ä¿¡æ¯
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          {
            echo "# å¹¿å‘Šè§„åˆ™åˆå¹¶ç»Ÿè®¡"
            echo ""
            echo "## åŸºæœ¬ä¿¡æ¯"
            echo "- æ›´æ–°æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
            echo "- æ€»è§„åˆ™æ•°: $(wc -l < adblock_rules.txt)"
            echo "- è§„åˆ™æ¥æº: 7ä¸ªå¹¿å‘Šæ‹¦æˆªåˆ—è¡¨"
            echo ""
            echo "## è§„åˆ™é¢„è§ˆï¼ˆå‰20æ¡ï¼‰"
            echo '```'
            head -20 adblock_rules.txt
            echo '```'
            echo ""
            echo "## ä½¿ç”¨è¯´æ˜"
            echo "åœ¨ AdGuard Home ä¸­æ·»åŠ è®¢é˜…é“¾æ¥:"
            echo '```'
            echo "https://raw.githubusercontent.com/${{ github.repository }}/main/adblock_rules.txt"
            echo '```'
          } > stats.md

      - name: ä¸Šä¼ ç»Ÿè®¡ä¿¡æ¯
        if: steps.check_changes.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: rule-stats
          path: stats.md
